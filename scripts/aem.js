/*
 * Copyright 2025 Adobe. All rights reserved.
 * This file is licensed to you under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License. You may obtain a copy
 * of the License at http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under
 * the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR REPRESENTATIONS
 * OF ANY KIND, either express or implied. See the License for the specific language
 * governing permissions and limitations under the License.
 */
/* eslint-env browser */
function sampleRUM(e,t){const n=()=>window.performance?window.performance.now():Date.now()-window.hlx.rum.firstReadTime;try{if(window.hlx=window.hlx||{},!window.hlx.rum){sampleRUM.enhance=()=>{};const o=new URLSearchParams(window.location.search).get("rum"),i="on"===o&&1||"high"===window.SAMPLE_PAGEVIEWS_AT_RATE&&10||"low"===window.SAMPLE_PAGEVIEWS_AT_RATE&&1e3||100,a=Math.random().toString(36).slice(-4),r="off"!==o&&Math.random()*i<1;window.hlx.rum={weight:i,id:a,isSelected:r,firstReadTime:window.performance?window.performance.timeOrigin:Date.now(),sampleRUM,queue:[],collector:(...e)=>window.hlx.rum.queue.push(e)},r&&(window.addEventListener("error",({error:e})=>{sampleRUM("error",((e=>{const t={source:"undefined error"};try{t.target=e.toString(),t.source=e.stack.split("\n").filter((e=>e.match(/https?:\/\//))).shift().replace(/at ([^ ]+) \((.+)\)/,"$1@$2").replace(/ at /,"@").trim()}catch(e){}return t})(e))}),window.addEventListener("unhandledrejection",({reason:e})=>{let t={source:"Unhandled Rejection",target:e||"Unknown"};e instanceof Error&&(t=((e=>{const t={source:"undefined error"};try{t.target=e.toString(),t.source=e.stack.split("\n").filter((e=>e.match(/https?:\/\//))).shift().replace(/at ([^ ]+) \((.+)\)/,"$1@$2").replace(/ at /,"@").trim()}catch(e){}return t})(e)));sampleRUM("error",t)}),sampleRUM.baseURL=sampleRUM.baseURL||new URL(window.RUM_BASE||"/",new URL("https://rum.hlx.page")),sampleRUM.collectBaseURL=sampleRUM.collectBaseURL||sampleRUM.baseURL,sampleRUM.sendPing=(e,t,a={})=>{const r=JSON.stringify({weight:i,id:a,referer:window.location.href,checkpoint:e,t, ...a}),s=window.RUM_PARAMS?`?${new URLSearchParams(window.RUM_PARAMS).toString()}`:"",{href:l,origin:c}=new URL(`.rum/${i}${s}`,sampleRUM.collectBaseURL),d=c===window.location.origin?new Blob([r],{type:"application/json"}):r;navigator.sendBeacon(l,d),console.debug(`ping:${e}`,a)},sampleRUM.sendPing("top",n()),sampleRUM.enhance=()=>{if(document.querySelector('script[src*="rum-enhancer"]'))return;const{enhancerVersion:e,enhancerHash:t}=sampleRUM.enhancerContext||{},n=document.createElement("script");t&&(n.integrity=t,n.setAttribute("crossorigin","anonymous")),n.src=new URL(`.rum/@adobe/helix-rum-enhancer@${e||"^2"}/src/index.js`,sampleRUM.baseURL).href,document.head.appendChild(n)},window.hlx.RUM_MANUAL_ENHANCE||sampleRUM.enhance())}window.hlx.rum&&window.hlx.rum.isSelected&&e&&window.hlx.rum.collector(e,t,n()),document.dispatchEvent(new CustomEvent("rum",{detail:{checkpoint:e,data:t}}))}catch(e){}}function setup(){window.hlx=window.hlx||{},window.hlx.RUM_MASK_URL="full",window.hlx.RUM_MANUAL_ENHANCE=!0,window.hlx.codeBasePath="",window.hlx.lighthouse="on"===new URLSearchParams(window.location.search).get("lighthouse");const e=document.querySelector('script[src$="/scripts/scripts.js"]');if(e)try{[window.hlx.codeBasePath]=new URL(e.src).pathname.split("/scripts/scripts.js")}catch(e){console.log(e)}}function init(){setup(),sampleRUM.collectBaseURL=window.origin,sampleRUM()}function toClassName(e){return"string"==typeof e?e.toLowerCase().replace(/[^0-9a-z]/gi,"-").replace(/-+/g,"-").replace(/^-|-$/g,""):""}function toCamelCase(e){return toClassName(e).replace(/-([a-z])/g,(e=>e[1].toUpperCase()))}function readBlockConfig(e){const t={};return e.querySelectorAll(":scope > div").forEach((e=>{if(e.children){const n=[...e.children];if(n[1]){const o=n[1],i=toClassName(n[0].textContent);let a="";if(o.querySelector("a")){const e=[...o.querySelectorAll("a")];a=1===e.length?e[0].href:e.map((e=>e.href))}else if(o.querySelector("img")){const e=[...o.querySelectorAll("img")];a=1===e.length?e[0].src:e.map((e=>e.src))}else if(o.querySelector("p")){const e=[...o.querySelectorAll("p")];a=1===e.length?e[0].textContent:e.map((e=>e.textContent))}else a=e.children[1].textContent;t[i]=a}}}})),t}async function loadCSS(e){return new Promise(((t,n)=>{if(document.querySelector(`head > link[href="${e}"]`))t();else{const n=document.createElement("link");n.rel="stylesheet",n.href=e,n.onload=t,n.onerror=n,document.head.append(n)}}))}async function loadScript(e,t){return new Promise(((n,o)=>{if(document.querySelector(`head > script[src="${e}"]`))n();else{const o=document.createElement("script");if(o.src=e,t)for(const e in t)o.setAttribute(e,t[e]);o.onload=n,o.onerror=o,document.head.append(o)}}))}function getMetadata(e,t=document){const n=e&&e.includes(":")?"property":"name";return[...t.head.querySelectorAll(`meta[${n}="${e}"]`)].map((e=>e.content)).join(", ")||""}function createOptimizedPicture(e,t="",n=!1,o=[{media:"(min-width: 600px)",width:"2000"},{width:"750"}]){const i=new URL(e,window.location.href),a=document.createElement("picture"),{pathname:r}=i,s=r.substring(r.lastIndexOf(".")+1);o.forEach((e=>{const t=document.createElement("source");e.media&&t.setAttribute("media",e.media),t.setAttribute("type","image/webp"),t.setAttribute("srcset",`${r}?width=${e.width}&format=webply&optimize=medium`),a.appendChild(t)})),o.forEach(((e,i)=>{if(i<o.length-1){const t=document.createElement("source");e.media&&t.setAttribute("media",e.media),t.setAttribute("srcset",`${r}?width=${e.width}&format=${s}&optimize=medium`),a.appendChild(t)}else{const o=document.createElement("img");o.setAttribute("loading",n?"eager":"lazy"),o.setAttribute("alt",t),a.appendChild(o),o.setAttribute("src",`${r}?width=${e.width}&format=${s}&optimize=medium`)}}));return a}function decorateTemplateAndTheme(){const e=(e,t)=>{t.split(",").forEach((t=>{e.classList.add(toClassName(t.trim()))}))},t=getMetadata("template");t&&e(document.body,t);const n=getMetadata("theme");n&&e(document.body,n)}function wrapTextNodes(e){const t=["P","PRE","UL","OL","PICTURE","TABLE","H1","H2","H3","H4","H5","H6"],n=e=>{const t=document.createElement("p");t.append(...e.childNodes),e.append(t)};e.querySelectorAll(":scope > div > div").forEach((e=>{if(e.hasChildNodes()){const o=!!e.firstElementChild&&t.some((t=>e.firstElementChild.tagName===t));o||(n(e)),e.firstElementChild.tagName==="PICTURE"&&(e.children.length>1||!!e.textContent.trim())&&n(e)}}))}function decorateButtons(e){e.querySelectorAll("a").forEach((t=>{if(t.title=t.title||t.textContent,t.href!==t.textContent){const n=t.parentElement,o=t.parentElement.parentElement;t.querySelector("img")||(1===n.childNodes.length&&("P"===n.tagName||"DIV"===n.tagName)&&(t.className="button",n.classList.add("button-container")),1===n.childNodes.length&&"STRONG"===n.tagName&&1===o.childNodes.length&&"P"===o.tagName&&(t.className="button primary",o.classList.add("button-container")),1===n.childNodes.length&&"EM"===n.tagName&&1===o.childNodes.length&&"P"===o.tagName&&(t.className="button secondary",o.classList.add("button-container")))}}))}function decorateIcon(e,t="",n=""){const o=Array.from(e.classList).find((e=>e.startsWith("icon-"))).substring(5),i=document.createElement("img");i.dataset.iconName=o,i.src=`${window.hlx.codeBasePath}${t}/icons/${o}.svg`,i.alt=n,i.loading="lazy",i.width=16,i.height=16,e.append(i)}function decorateIcons(e,t=""){e.querySelectorAll("span.icon").forEach((e=>{decorateIcon(e,t)}))}function decorateSections(e){e.querySelectorAll(":scope > div").forEach((e=>{const t=[],n=!1;[...e.children].forEach((o=>{"DIV"===o.tagName||!n?(t.push(document.createElement("div")),defaultContent="DIV"!==o.tagName,defaultContent&&t[t.length-1].classList.add("default-content-wrapper")):void 0,t[t.length-1].append(o)})),t.forEach((t=>e.append(t))),e.classList.add("section"),e.dataset.sectionStatus="initialized",e.style.display="none";const o=e.querySelector("div.section-metadata");if(o){const t=readBlockConfig(o);Object.keys(t).forEach((n=>{"style"===n?t.style.split(",").filter((e=>e)).map((e=>toClassName(e.trim()))).forEach((t=>e.classList.add(t))):e.dataset[toCamelCase(n)]=t[n]})),o.parentNode.remove()}}))}function buildBlock(e,t){const n=Array.isArray(t)?t:[[t]],o=document.createElement("div");return o.classList.add(e),n.forEach((e=>{const t=document.createElement("div");e.forEach((e=>{const n=document.createElement("div"),o=e.elems?e.elems:[e];o.forEach((e=>{e&&("string"==typeof e?n.innerHTML+=e:n.appendChild(e))})),t.appendChild(n)})),o.appendChild(t)})),o}async function loadBlock(e){const t=e.dataset.blockStatus;if("loading"!==t&&"loaded"!==t){e.dataset.blockStatus="loading";const t=e.dataset.blockName;try{const n=loadCSS(`${window.hlx.codeBasePath}/blocks/${t}/${t}.css`),o=new Promise((n=>{(async()=>{try{const o=await import(`${window.hlx.codeBasePath}/blocks/${t}/${t}.js`);o.default&&await o.default(e)}catch(e){console.log(`failed to load module for ${t}`,e)}n()})()}));await Promise.all([n,o])}catch(n){console.log(`failed to load block ${t}`,n)}e.dataset.blockStatus="loaded"}return e}function decorateBlock(e){const t=e.classList[0];t&&(e.classList.add("block"),e.dataset.blockName=t,e.dataset.blockStatus="initialized",wrapTextNodes(e),e.parentElement.classList.add(`${t}-wrapper`),(e.closest(".section")||{}).classList&&e.closest(".section").classList.add(`${t}-container`))}function decorateBlocks(e){e.querySelectorAll("div.section > div > div").forEach(decorateBlock)}async function loadHeader(e){const t=buildBlock("header","");return e.append(t),decorateBlock(t),loadBlock(t)}async function loadFooter(e){const t=buildBlock("footer","");return e.append(t),decorateBlock(t),loadBlock(t)}async function waitForFirstImage(e){const t=e.querySelector("img");await new Promise((e=>{t&&!t.complete?(t.setAttribute("loading","eager"),t.addEventListener("load",e),t.addEventListener("error",e)):e()}))}async function loadSection(e,t){const n=e.dataset.sectionStatus;if(!n||"initialized"===n){e.dataset.sectionStatus="loading";const n=[...e.querySelectorAll("div.block")];for(let e=0;e<n.length;e+=1)await loadBlock(n[e]);t&&await t(e),e.dataset.sectionStatus="loaded",e.style.display=null}}async function loadSections(e){const t=[...e.querySelectorAll("div.section")];for(let n=0;n<t.length;n+=1)await loadSection(t[n]),0===n&&sampleRUM.enhance&&sampleRUM.enhance()}init();export{buildBlock,createOptimizedPicture,decorateBlock,decorateBlocks,decorateButtons,decorateIcons,decorateSections,decorateTemplateAndTheme,getMetadata,loadBlock,loadCSS,loadFooter,loadHeader,loadScript,loadSection,loadSections,readBlockConfig,sampleRUM,setup,toCamelCase,toClassName,waitForFirstImage,wrapTextNodes};
